{% extends 'base.html' %}

{% load static humanize %}
{% load partials %}
{% load core_extra %}

{% block title %}
  Stats | {{ block.super }}
{% endblock title %}
{% block page_title %}
  Stats
{% endblock page_title %}
{% block content %}
  <div class="row row-cards mb-3">
    <div class="col-lg-12">
      <div id="daily-projects-card"
           hx-on::after-request="renderDailyProjectChart()">
        {% partialdef daily-projects-card inline %}
        <div class="card position-relative">
          <div class="card-body">
            <div class="d-flex">
              <h3 class="card-title">
                Projects
                <small class="text-muted fst-italic">({{ daily_total|intcomma }})</small>
              </h3>
              <div class="ms-auto">
                <div class="dropdown">
                  <a class="dropdown-toggle text-secondary"
                     href="#"
                     data-bs-toggle="dropdown"
                     aria-haspopup="true"
                     aria-expanded="false">{{ selected_period_label }}</a>
                  <div class="dropdown-menu dropdown-menu-end"
                       hx-target="#daily-projects-card">
                    {% for value, label in PeriodOption.choices %}
                      <a class="dropdown-item {% if selected_period_label == label %}active{% endif %}"
                         href="#"
                         hx-get="?period={{ value }}"
                         hx-indicator="next .spinner-backdrop"
                         hx-push-url="true">{{ label }}</a>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
            <div class="d-flex flex-wrap justify-content-between">
              {% for source, total in source_totals.items %}
                <div class="px-3">
                  <div class="text-secondary">
                    <span class="status-dot" style="background: {% source_color source %};"></span> {{ source }}
                  </div>
                  <div class="h2 text-center">{{ total|intcomma }}</div>
                </div>
                {% if not forloop.last %}<div class="vr"></div>{% endif %}
              {% endfor %}
            </div>
            <div id="chart-projects"></div>
          </div>
          {{ source_daily_count|json_script:"source-daily-count" }}
          {{ day_list|json_script:"day-list" }}
          <div class="spinner-backdrop">
            <div class="spinner-border spinner-border-lg text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
      {% endpartialdef daily-projects-card %}
    </div>
  </div>
</div>
<div class="row row-cards mb-3">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-body">
        <div class="d-flex">
          <h3 class="card-title">
            Projects per source
            <small class="text-muted fst-italic">({{ project_count|intcomma }} projects)</small>
          </h3>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div id="chart-projects-per-source"></div>
          </div>
          <div class="col-md-6 mt-3 mt-md-0">
            <div class="row align-items-center h-100">
              {% for item in projects_per_source %}
                <div class="col-6 mb-4">
                  <div class="row align-items-center sources">
                    <div class="col-auto">
                      <img src="{% static 'img/'|add:item.source|add:'.png' %}"
                           width="50"
                           alt="{{ item.source }} logo" />
                    </div>
                    <div class="col">
                      <div class="font-weight-medium">{{ item.total|intcomma }} Projects</div>
                      {% widthratio item.total project_count 100 as percentage %}
                      <div class="text-secondary">{{ item.source }} ({{ percentage }}%)</div>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}
{% block inline_javascript %}
  {{ source_colors|json_script:"source-colors" }}
  {{ projects_per_source|json_script:"projects-per-source" }}
  <script>
    const sourceColors = JSON.parse(document.querySelector("#source-colors").textContent);
    const projectsPerSource = JSON.parse(document.querySelector('#projects-per-source').textContent);

    function renderDailyProjectChart() {
      const series = JSON.parse(document.querySelector('#source-daily-count').textContent);
      const labels = JSON.parse(document.querySelector('#day-list').textContent);
      renderChart(document.getElementById("chart-projects"), {
        chart: {
          type: "line",
          fontFamily: "inherit",
          height: 380,
          parentHeightOffset: 0,
          toolbar: {
            show: false,
          },
          animations: {
            enabled: false,
          },
        },
        stroke: {
          width: 2,
          lineCap: "round",
          curve: "smooth",
        },
        series: series,
        grid: {
          padding: {
            top: 0,
            right: 0,
            left: -4,
            bottom: -4,
          },
          strokeDashArray: 4,
        },
        xaxis: {
          labels: {
            padding: 0,
          },
          tooltip: {
            enabled: false,
          },
          type: "date",
        },
        yaxis: {
          labels: {
            padding: 4,
          },
        },
        labels: labels,
        colors: sourceColors,
      });
    }
    const totalProjectsChartConfig = {
      chart: {
        type: "donut",
        fontFamily: "inherit",
        height: 320,
        sparkline: {
          enabled: true,
        },
        animations: {
          enabled: false,
        },
      },
      series: projectsPerSource.map(item => item.total),
      labels: projectsPerSource.map(item => item.source),
      colors: sourceColors,
      dataLabels: {
        enabled: true,
        formatter: function(val) {
          return val.toFixed() + "%";
        },
        style: {
          fontSize: '14px',
          fontWeight: 'bold'
        }
      }
    };
    document.addEventListener('DOMContentLoaded', function() {
      renderDailyProjectChart();
      renderChart(document.getElementById("chart-projects-per-source"), totalProjectsChartConfig);
    })
  </script>
{% endblock inline_javascript %}
